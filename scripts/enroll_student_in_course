CREATE OR REPLACE FUNCTION enroll_student_in_course(
    p_user_id INTEGER,
    p_course_id INTEGER
)
RETURNS VOID AS $$
BEGIN
    -- Проверяем, существует ли курс и активен ли он
    IF NOT EXISTS (SELECT 1 FROM courses WHERE course_id = p_course_id AND status = 'active') THEN
        RAISE EXCEPTION 'Курс не найден или неактивен.';
    END IF;

    INSERT INTO course_enrollments (user_id, course_id, status)
    VALUES (p_user_id, p_course_id, 'pending');

EXCEPTION
    WHEN unique_violation THEN
        RAISE EXCEPTION 'Пользователь уже записан на этот курс.';
    WHEN OTHERS THEN
        RAISE;
END;
$$ LANGUAGE plpgsql;
